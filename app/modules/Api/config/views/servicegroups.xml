<?xml version="1.0" encoding="UTF-8"?>
<ae:configurations xmlns:view="http://icinga.org/icinga/config/global/api/views/1.0"
    xmlns:ae="http://agavi.org/agavi/config/global/envelope/1.0" 
>
    <ae:configuration>
        <dql name="TARGET_SERVICEGROUP_SERVICES" >
            <query>
            <![CDATA[
                SELECT DISTINCT
                    sg.servicegroup_id AS servicegroup_id,
                    sgm.service_object_id AS service_object_id
                    FROM IcingaServicegroups sg
                    INNER JOIN sg.object o
                    INNER JOIN sg.members sgm

            ]]>
            </query>
            <credential name="UserObjectId" type="UserObjectId">
                <parameter name="target_fields">sgm.service_object_id</parameter>
                <parameter name="aggregation">or</parameter>
            </credential>
        </dql>

        <dql name="TARGET_SERVICEGROUP_SUMMARY" >
            <query>
                <![CDATA[
                SELECT 
                    o.name1 AS servicegroup_name,
                    sg.alias AS servicegroup_alias,
                    sg.servicegroup_id AS servicegroup_id,
                    i.instance_id AS instance_id,
                    i.instance_name AS instance_name,
                    COUNT(ss.current_state) AS service_status_count,
                    ss.current_state AS service_status,
                    sg.servicegroup_id as servicegroup_id,
                    ss.has_been_checked as service_has_been_checked
                FROM IcingaServicegroups sg
                INNER JOIN sg.instance i
                INNER JOIN sg.object o
                INNER JOIN sg.members sgm
                INNER JOIN sgm.status ss
                INNER JOIN ss.service s

                GROUP BY sg.servicegroup_id, ss.current_state, o.name1,
                    sg.alias, sg.servicegroup_id, i.instance_id, i.instance_name,
                    ss.has_been_checked
                
                WHERE s.config_type = '${retained_flag}'
                ]]>
           </query>
           
            <credential name="UserObjectId" type="UserObjectId">
                <parameter name="target_fields">s.host_object_id, s.service_object_id</parameter>
                <parameter name="aggregation">or</parameter>
            </credential>
        </dql>

    </ae:configuration>
</ae:configurations>
