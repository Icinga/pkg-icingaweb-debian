<?xml version="1.0" encoding="UTF-8"?>
<ae:configurations xmlns:view="http://icinga.org/icinga/config/global/api/views/1.0"
    xmlns:ae="http://agavi.org/agavi/config/global/envelope/1.0"
>
    <ae:configuration>
        <dql name="TARGET_SERVICE" >
            <query>
            <![CDATA[
            SELECT
                s.icon_image AS SERVICE_ICON_IMAGE,
                i.instance_name AS INSTANCE_NAME,
                h.host_object_id AS HOST_OBJECT_ID,
                s.service_object_id AS SERVICE_OBJECT_ID,
                oh.name1 AS HOST_NAME,
                h.alias AS HOST_ALIAS,
                h.display_name AS HOST_DISPLAY_NAME,
                os.name2 AS SERVICE_NAME,
                s.display_name AS SERVICE_DISPLAY_NAME,
                ss.process_performance_data AS SERVICE_PROCESS_PERFORMANCE_DATA,
                ss.current_state AS SERVICE_CURRENT_STATE,
                hs.current_state AS HOST_CURRENT_STATE,
                (CASE WHEN ss.last_state_change<='1970-01-01 00:00:00' THEN ps.program_start_time ELSE ss.last_state_change END) as DURATION_START,
                ps.program_start_time AS SERVICE_PROGRAM_START_TIME,
                ss.last_check AS SERVICE_LAST_CHECK,
                ss.next_check AS SERVICE_NEXT_CHECK,
                ss.output AS SERVICE_OUTPUT,
                ss.perfdata AS SERVICE_PERFORMANCE_DATA,                
                ss.current_check_attempt AS SERVICE_CURRENT_CHECK_ATTEMPT,
                ss.max_check_attempts AS service_max_attempt,
                i.instance_id AS SERVICE_INSTANCE_ID,
                s.service_id AS SERVICE_ID,
                ss.notifications_enabled as notifications_enabled,
                ss.problem_has_been_acknowledged as problem_acknowledged,
                ss.scheduled_downtime_depth as scheduled_downtime_depth,
                s.action_url AS SERVICE_ACTION_URL,
                h.notes as HOST_NOTES,
                h.notes_url AS HOST_NOTES_URL,
                s.notes as SERVICE_NOTES
                s.notes_url AS SERVICE_NOTES_URL,
                ss.has_been_checked as service_has_been_checked
            FROM IcingaServices s
            INNER JOIN s.instance i
            INNER JOIN s.status ss
            INNER JOIN s.host h
            INNER JOIN h.status hs
            INNER JOIN h.object oh
            INNER JOIN s.object os
            INNER JOIN i.programstatus as ps

            WHERE s.config_type = '${retained_flag}'
            ]]>
            </query>
            
            <credential name="UserObjectId" type="UserObjectId">
                <parameter name="target_fields">s.host_object_id, s.service_object_id</parameter>
                <parameter name="aggregation">or</parameter>
            </credential>

            <!--
                Additional fields that are used in cronk filtering
            -->
            <filter name="customvariable_name" type="dql">
                <join>s.customvariables cvs</join>
                <select>cvs.varname AS customvariable_name</select>
            </filter>

            <filter name="customvariable_value" type="dql">
                <join>s.customvariables cvs</join>
                <select>cvs.varvalue AS customvariable_value</select>
            </filter>
            <filter name="host_customvariable_name" type="dql">
                <leftjoin>h.customvariables cvh</leftjoin>
                <select>cvh.varname AS host_customvariable_name</select>
            </filter>

            <filter name="host_customvariable_value" type="dql">
                <leftjoin>h.customvariables cvh</leftjoin>
                <select>cvh.varvalue AS host_customvariable_value</select>
            </filter>

            <filter name="hostgroup_name" type="dql">
                <innerjoin>h.hostgroups hg</innerjoin>
                <innerjoin>hg.object ohg</innerjoin>
                <select>ohg.name1 AS hostgroup_name</select>
                <groupby>s.service_object_id</groupby>              
            </filter>

            <filter name="servicegroup_name" type="dql">
                <innerjoin>s.servicegroups sg</innerjoin>
                <innerjoin>sg.object osg</innerjoin>
                <select>osg.name1 AS servicegroup_name</select>
                <groupby>s.service_object_id</groupby>
                
            </filter>
            
            <filter name="service_is_pending" type="dql">
                <resolve>((ss.has_been_checked-1)*-1)</resolve>
                <select>(ss.has_been_checked-1)*-1 AS service_is_pending</select>
            </filter>

         </dql>

         <dql name="TARGET_SERVICE_OPEN_PROBLEMS" base="TARGET_SERVICE" >
             <query>
            <![CDATA[
            SELECT
                s.icon_image AS SERVICE_ICON_IMAGE,
                i.instance_name AS INSTANCE_NAME,
                h.host_object_id AS HOST_OBJECT_ID,
                s.service_object_id AS SERVICE_OBJECT_ID,
                oh.name1 AS HOST_NAME,
                h.alias AS HOST_ALIAS,
                h.display_name AS HOST_DISPLAY_NAME,
                os.name2 AS SERVICE_NAME,
                s.display_name AS SERVICE_DISPLAY_NAME,
                ss.current_state AS SERVICE_CURRENT_STATE,
                (CASE WHEN ss.last_state_change<='1970-01-01 00:00:00' THEN ps.program_start_time ELSE ss.last_state_change END) as DURATION_START,
                ss.process_performance_data AS SERVICE_PROCESS_PERFORMANCE_DATA,
                ss.last_check AS SERVICE_LAST_CHECK,
                ss.next_check AS SERVICE_NEXT_CHECK,
                ss.output AS SERVICE_OUTPUT,
                ss.current_check_attempt AS SERVICE_CURRENT_CHECK_ATTEMPT,
                ss.max_check_attempts AS SERVICE_MAX_CHECK_ATTEMPTS,
                ss.perfdata AS SERVICE_PERFORMANCE_DATA,                
                ss.max_check_attempts AS service_max_attempt,
                i.instance_id AS SERVICE_INSTANCE_ID,
                s.service_id AS SERVICE_ID,
                ss.notifications_enabled as notifications_enabled,
                ss.problem_has_been_acknowledged as problem_acknowledged,
                ss.scheduled_downtime_depth as scheduled_downtime_depth,
                ss.has_been_checked as service_has_been_checked,
                s.action_url AS SERVICE_ACTION_URL,
                s.notes_url AS SERVICE_NOTES_URL
            FROM IcingaServices s
            INNER JOIN s.instance i
            INNER JOIN s.status ss
            INNER JOIN s.host h
            INNER JOIN h.object oh
            INNER JOIN s.object os
            INNER JOIN i.programstatus as ps
            WHERE
                s.config_type = '${retained_flag}' AND
                ss.scheduled_downtime_depth = 0 AND
                ss.current_state != 0 AND
                ss.problem_has_been_acknowledged != 1
            ]]>
            </query>

         </dql>
     </ae:configuration>
</ae:configurations>
